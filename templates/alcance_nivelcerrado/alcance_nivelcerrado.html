{% extends "basebs.html" %}
{% block heading %}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html"
            xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
        $(function() {
            var nota1=0;
            var nota2=0;
            var nota3=0;
            var nota4=0;
            var examen=0;
            var recupera = 0;

            var notaalcance=0;
            var alcancenota1=0;
            var alcancenota2=0;
            var alcancenota3=0;
            var alcancenota4=0;
            var alcanceexamen=0;
            var alcancerecupera = 0;
            var reprobado={{ reprobado }};
            var posicion='';
            var idmateriaasig=0

            var min_aproba ={{ min_aproba }};
            var min_recupera = {{ min_recupera }};
            var max_recupera = {{ max_recupera }};
            var min_exa = {{ min_exa }};
            var max_exa = {{ max_exa }};
            var min_exarecupera = {{ min_exarecupera }};

             $(".nota1").change(function(){
                 porcnota1={{porcnota1}};
                 nota1= ($(this).val());
                 asignada=$(this).attr("maid");
                 if (nota1 > porcnota1){
                     ($(this).val(0));
                     nota1=0;
                 }
                 else{
                      $(this).attr("style",'background: yellow; font-weight: bold;');
                      actualizarnotas(nota1,asignada,'n1')
                 }
             });

             $(".nota2").change(function(){
                porcnota2={{porcnota2}};
                 nota2= ($(this).val());
                 asignada=$(this).attr("maid");
                 if (nota2 > porcnota2){
                     ($(this).val(0));
                     nota2=0;
                 }
                 else{
                      $(this).attr("style",'background: yellow; font-weight: bold;');
                      actualizarnotas(nota2,asignada,'n2')
                 }
             });

             $(".nota3").change(function(){
                porcnota3={{porcnota3}};
                nota3= ($(this).val());
                asignada=$(this).attr("maid");
                if (nota3 > porcnota3){
                    ($(this).val(0));
                    nota3=0;
                }
                 else{
                    $(this).attr("style",'background: yellow; font-weight: bold;');
                    actualizarnotas(nota3,asignada,'n3')
                }
             });

             $(".nota4").change(function(){
                asignada=$(this).attr("val");
                porcnota4={{porcnota4}};
                nota4= ($(this).val());

                if (nota4 > porcnota4){
                    ($(this).val(0));
                    nota4=0;
                }
                else{
                    $("#n4"+asignada).attr("style",'background: yellow; font-weight: bold;');
                    actualizarnotas(nota4,asignada,'n4')
                }
             });

             $(".notaexamen").change(function(){
                var examen= ($(this).val());
                porcnota5={{porcnota5}};
                notexamen= {{ min_exa }};
                asignada=$(this).attr("maid");

                if (examen > porcnota5){
                    ($(this).val(0));
                    examen=0;
                }
                else{
                      $(this).attr("style",'background: yellow; font-weight: bold;');
                      actualizarnotas(examen,asignada,'examen')
                }
             });

            $(".notarecupera").change(function(){
                recupera= ($(this).val());
                asignada=$(this).attr("maid");
                $(this).attr("style",'background: yellow; font-weight: bold;');
                actualizarnotas(recupera,asignada,'recuperacion')
            });

            $(".alcancenota1").change(function(){
                 porcnota1={{porcnota1}};
                 posicion='n1';
                 notaalcance= ($(this).val());
                 if (notaalcance > porcnota1){
                     ($(this).val(0));
                     notaalcance=0;
                 }
                 else{
                     asignada=$(this).attr("maid");
                     verifica_obsmot(asignada)
                 }
             });

            $(".alcancenota1").blur(function(){
                notaalcance= ($(this).val());
                posicion='n1';
            });

             $(".alcancenota2").change(function(){
                 porcnota2={{porcnota2}};
                 posicion='n2';
                 notaalcance= ($(this).val());
                 if (notaalcance > porcnota2){
                     ($(this).val(0));
                     notaalcance=0;
                 }
             });

             $(".alcancenota2").blur(function(){
                notaalcance= ($(this).val());
                posicion='n2';
             });

             $(".alcancenota3").change(function(){
                 porcnota3={{porcnota3}};
                 posicion='n3';
                 notaalcance= ($(this).val());
                 if (notaalcance > porcnota3){
                     ($(this).val(0));
                     notaalcance=0;
                 }
             });

             $(".alcancenota3").blur(function(){
                notaalcance= ($(this).val());
                posicion='n3';
             });

             $(".alcancenota4").change(function(){
                 porcnota4={{porcnota4}};
                 posicion='n4';
                 notaalcance= ($(this).val());
                 if (notaalcance > porcnota4){
                     ($(this).val(0));
                     notaalcance=0;
                 }
             });
             $(".alcancenota4").blur(function(){
                notaalcance= ($(this).val());
                posicion='n4';
             });

             $(".alcanceexamen").change(function(){
                 notaalcance= ($(this).val());
                 porcnota5={{porcnota5}};
                 notexamen= {{ min_exa }};
                 posicion='examen';
                 if (notaalcance > porcnota5){
                     ($(this).val(0));
                     notaalcance=0;
                 }
                 if (notaalcance < notexamen){
                     ($(this).val(0));
                     notaalcance=0;
                 }

             });

             $(".alcanceexamen").blur(function(){
                notaalcance= ($(this).val());
                posicion='examen';
             });

            $(".alcancerecupera").blur(function(){
                recuperacion={{ min_exarecupera }}
                posicion='recuperacion';
                notaalcance= ($(this).val());
            });

            {#OCastillo 06-08-2019 llamar a esta funcion por cada cambio de nota            #}
            actualizarnotas = function (nota,asignada,posicion) {
                nota=nota;
                matasignada=asignada;
                posicion=posicion;
                 $.post("/alcance_nivelcerrado", {'action':'actualizanotas','matasignada': matasignada,'nota':nota,'posicion':posicion}, function(data) {
                    if (data.result=="ok") {
                        location.reload();
                    } else {
                        self.val(0);
                        location.reload();
                    }
                }, "json");
            };

            $(".actualizanotas").change(function(){
                 matasignada=$(this).attr("idmateria");
                 $.post("/alcance_nivelcerrado", {'action':'actualizanotas','matasignada': matasignada,'nota1':nota1,'nota2':nota2,'nota3':nota3,'nota4':nota4,'examen': examen,'recupera':recupera}, function(data) {
                    if (data.result=="ok") {
                        smoke.alert("Las nuevas notas seran validadas ");
                        location.reload();
                    } else {
                        self.val(0);
                        location.reload();
                    }
                }, "json");
            });

            $("#search").click(function() {
                var term = $("#searchinput").val().toUpperCase();
                location.href = "/alcance_nivelcerrado?s="+term;
            });

            $("#selector").change(function() {
                var term =$("#selector").val();
                if (term >0) {
                    location.href = "/alcance_nivelcerrado?id="+term;
                }

            });

            $('#searchinput').keyup(function(e) {
                if(e.keyCode == 13) {
                    $("#search").trigger("click");
                }
            });


            $(".btn-info").click(function() {
                idmateriaasig=$(this).attr("id");
                $("#motivopanel").modal('show');
                return false;
            });

            $("#motivopanel .btn-ejecutar").click(function(){
                $("#motivopanel").modal('hide');
                var tipomotivo = $("#motivopanel #seltrans").find('option:selected').attr('value');
                $.post("/alcance_nivelcerrado", {'action':'motivonota','matasignada': idmateriaasig,'tipomotivo':tipomotivo}, function(data) {
                    if (data.result=="ok") {
                        location.reload();
                    } else {
                        smoke.alert("Error en ingreso ");
                        location.reload();
                    }
                }, "json");
            });

            $("#motivopanel .btn-cerrar").click(function(){
                $("#motivopanel #seltrans").val("");
                $("#motivopanel").modal('hide');
                return false;
            });


            $(".btn-aprobar").click(function() {
                idmateriaasig=$(this).attr("matid");
                $("#tipoaprobacionpanel #id_respuesta").val("");
                $("#tipoaprobacionpanel #id_aprobado").attr('checked',false);
                $("#tipoaprobacionpanel #id_reprobado").attr('checked',false);
                $("#tipoaprobacionpanel").modal('show');
                return false;
            });

            $("#tipoaprobacionpanel .btn-guardar").click(function(){
                $("#tipoaprobacionpanel").modal('hide');
                var aprobado = 0;
                var reprobado = 0;
                if ( (!$("#id_aprobado").is(':checked')) && (!$("#id_reprobado").is(':checked')) ) {
                        smoke.alert('DEBE APROBAR O NO LA SOLICITUD');
                    }
                else{
                    if ($("#id_aprobado").is(':checked')){
                        aprobado = 1;
                    }
                    else{
                        aprobado = 0;
                    }
                    $.post("/alcance_notas", {'action':'aprobacionnota','matasignada': idmateriaasig,'estado':aprobado,"obssecretaria": $('#id_respuesta').val()}, function(data) {
                        if (data.result=="ok") {
                            alert('REGISTRO GUARDADO');
                            location.reload();
                        } else {
                            smoke.alert("Error en ingreso ");
                        }
                    }, "json");
                }
            });

            $("#tipoaprobacionpanel .btn-cerrar").click(function(){
                $("#tipoaprobacionpanel #id_respuesta").val("");
                $("#tipoaprobacionpanel #id_aprobado").attr('checked',false);
                $("#tipoaprobacionpanel #id_reprobado").attr('checked',false);
                $("#tipoaprobacionpanel").modal('hide');
                return false;
            });

            $(".notascorreo").change(function(){
                ide=$(this).attr("idmat");
                $.post("/alcance_nivelcerrado", {'action':'notificacioncorreo','matasignada': ide}, function(data) {
                        if (data.result=="ok") {
                            smoke.alert("Finalizada la actualizacion ");
                            $(".notascorreo").attr('checked',false);
                            location.reload();
                        } else {
                            smoke.alert("Notas con valor 0 ");
                            $(".notascorreo").attr('checked',false);
                            location.reload();
                        }
                    }, "json");
            });

            $(".solicpermiso").change(function(){
                ide=$(this).attr("idmat");
                $.post("/alcance_nivelcerrado", {'action':'solicitudasecretaria','matasignada': ide}, function(data) {
                        if (data.result=="ok") {
                            smoke.alert("Correo enviado ");
                            $(".solicpermiso").attr('checked',false);
                            location.reload();
                        } else {
                            smoke.alert("No se genero el correo ");
                            $(".solicpermiso").attr('checked',false);
                            location.reload();
                        }
                    }, "json");
            });

            verifica = function (id) {

               var exam=  parseInt($("#exa"+id).val());
               var recupera = parseInt($("#recu"+id).val());
               var nota1= $("#n1"+id).val();
               var nota2= $("#n2"+id).val();
               var nota3= $("#n3"+id).val();
               var nota4= $("#n4"+id).val();
               var total=(parseInt(nota1)+parseInt(nota2)+parseInt(nota3)+parseInt(nota4));

               if ((total) == 0){
                $("#n4"+id).html("<i class='icon-eye-open' title='En Curso'></i>");
               }else{
                   if (total < min_recupera ){
                        $("#recu"+id).attr("disabled","disabled");
                        $("#exa"+id).attr("disabled","disabled");
                        $($("#n4"+id).get(0).parentNode).find(".help-text").html("<i class='icon-asterisk' title='Reprobado'></i>");
                        }
                   else{
                        if (total >= min_aproba ){
                            $("#recu"+id).attr("disabled","disabled");
                            $($("#n4"+id).get(0).parentNode).find(".help-text").html("<i class='icon-check' title='Examen'></i>");
                            $("#exa"+id).removeAttr("disabled","disabled");
                            $("#recu"+id).removeAttr("disabled","disabled")
                        }

                        if  (exam < min_exa ){
                            $($("#exa"+id).get(0).parentNode).find(".help-text").html("<i class='icon-eye-open' title='Pasa a Recuperacion'></i>");
                        }
                   }
               }
            }


        });
    </script>
{% endblock %}
{% block canvas %}
    <div class='row-fluid'>
        <div class='span11'>
            <h3 style="color: darkblue">Notas de Alcance Materia en Nivel Cerrado</h3>
            <h3 style="color: darkblue">{{ materia }}</h3>
            <h3 style="color: darkblue">Docente: {{ profesor.persona.nombre_completo_inverso }}</h3></br>
            <h2 style="color: orangered">IMPORTANTE: </h2>
                <h3 style="color:orangered ">Solo se podr&aacute; asentar notas en Nivel Cerrado a estudiantes cuyo estado sea diferente a: Aprobado y Reprobado.  </h3>
                <h3 style="color:orangered ">Para asentar notas en Nivel Cerrado, estudiante debe tener asistencia mayor o igual a 75% </h3>
                <h3 style="color:orangered ">Para asentar notas en Nivel Cerrado, estudiante debe comprar la respectiva especie y ser aprobada por la Coordinaci&oacute;n. </h3>
        </div>
        <br>

        <div class='span1'>
            <a href="/alcance_notas" class='btn'><i class="icon-arrow-left"></i> Atr&aacute;s</a>
        </div>
    </div>
    <br>
    <div class='row-fluid'>
        <div class="span12 atright" style="text-align: center;">
            <b>Buscar Materias</b>
               <select id="selector" class="input-xxlarge bigger">
                    <option value="">-----</option>
                    {% for m in materias %}'
                <option  {% if materia.id == m.id %}selected="selected"{% endif %} value="{{ m.id }}" >{{ m.asignatura }} - {{ m.nivel.paralelo }} - {{ m.nivel.nivelmalla.nombre }}</option>
                    {% endfor %}
               </select>
            </div>
    </div>
    <br>

    <div class='row-fluid'>
        <div class='span12'>
            <table class='table table-bordered table-striped' cellpadding="0" cellspacing="0">
                <thead>
                <tr>
                    <th style="background-color: lightblue;text-align: center;width: 20%"><h3>Estudiante</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Nota1</h3>{{ cod1.alias }} </th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Nota2 </h3>{{ cod2.alias }}</th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Nota3</h3>{{ cod3.alias }}</th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Nota4</h3>{{ cod4.alias }}</th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Examen</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Recup./Mej.</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Nota Final</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 3%"><h3>Asistencia</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Estado</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Motivo</h3></th>
                    <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Observaci&oacute;n</h3></th>

                    {% if perms.sga.change_nivel %}
                        <th style="background-color: lightblue;text-align: center;width: 8%"><h3>Aprobar</h3></th>
                        <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Estado Aprobaci&oacute;n</h3></th>
                        <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Motivo Aprobaci&oacute;n/Desaprobaci&oacute;n</h3></th>
                    {% else %}
                        <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Finalizar Cambio/Enviado</h3></th>
                        <th style="background-color: lightblue;text-align: center;width: 5%"><h3>Solicitar Permiso</h3></th>
                    {% endif %}
                </tr>

                </thead>
                <tbody>
                {% for mat in asignados %}
                    {% if not mat.matricula.esta_retirado %}
                        {% with notafinal=mat.evaluacion.nota_final_nueva tienedeudatmp=mat.matricula.inscripcion.tiene_deuda_temp %}
                            <tr>
                                <td style="background-color: aliceblue; text-align: center;width:15%">
                                    {{ mat.matricula.inscripcion.persona.nombre_completo_inverso }}<br/>
                                    {% if tienedeudatmp %}
                                        <span class='label label-important'>Deuda: ${{ mat.matricula.inscripcion.adeuda_a_la_fecha|floatformat:2 }}</span>
                                    {% endif %}
                                    {% if mat.ver_asentamiento %}
                                        <span class="label label-warning tl" title="Tiene Especie">{{ mat.ver_asentamiento }}</span><br>
                                    {% endif %}
                                    {% if mat.ver_examen %}
                                        <span class="label label-warning tl" title="Tiene Especie">{{ mat.ver_examen }}</span><br>
                                    {% endif %}
                                    {% if mat.ver_recuperacion %}
                                        <span class="label label-warning tl" title="Tiene Especie">{{ mat.ver_recuperacion }}</span><br>
                                    {% endif %}
                                    {% if mat.ver_mejoramiento %}
                                        <span class="label label-warning tl" title="Tiene Especie">{{ mat.ver_mejoramiento }}</span><br>
                                    {% endif %}
                                </td>
                                {% if mat.ver_recordmateria.asistencia >= asistencia_aprobar and not mat.ver_recordmateria.aprobada or not mat.ver_historiconotas.estado.id == reprobado %}
                                    {% if mat.tiene_evaluacionalcance.nivelmalla and mat.tiene_evaluacionalcance.observaciones and mat.tiene_evaluacionalcance.motivo %}
                                        {% if not mat.tiene_evaluacionalcance.aprobado and not mat.ver_recordmateria.aprobada and mat.ver_historiconotas.permitir %}
                                            {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.n1 }}</b><br/>
                                                    <input id='n1{{ mat.id }}' val='{{ mat.id }}' type="text" class="nota1 input-mini bigger" style="{% if mat.evaluacion.n1 %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.n1 }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='nota1'/>
                                                </td>
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.n2 }}</b><br/>
                                                    <input id='n2{{ mat.id }}' val='{{ mat.id }}' type="text" class="nota2 input-mini bigger" style="{% if mat.evaluacion.n2 %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.n2 }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='nota2'/>
                                                </td>
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.n3 }}</b><br/>
                                                    <input id='n3{{ mat.id }}' val='{{ mat.id }}' type="text" class="nota3 input-mini bigger" style="{% if mat.evaluacion.n3 %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.n3 }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='nota3'/>
                                                </td>
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.n4 }}</b><br/>
                                                    <input id='n4{{ mat.id }}' val='{{ mat.id }}' type="text" class="nota4 input-mini bigger" style="{% if mat.evaluacion.n4 %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.n4 }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='nota4'/>
                                                </td>
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.examen }}</b><br/>
                                                    <input onblur="verifica({{ mat.id }})" id='exa{{ mat.id }}' val='{{ mat.id }}' type="text" class="notaexamen input-mini bigger" style="{% if mat.evaluacion.examen %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.examen }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='examen'/>
                                                    <p class="help-text"></p>
                                                </td>
                                                <td>
                                                    <b style="color: green">{{ mat.tiene_evaluacionalcance.recuperacion }}</b><br/>
                                                    <input id='recu{{ mat.id }}' val='{{ mat.id }}' type="text" class="notarecupera input-mini bigger" style="{% if mat.evaluacion.recuperacion %}background: yellow; font-weight: bold;{% endif %}" value="{{ mat.evaluacion.recuperacion }}" maid='{{ mat.id }}' name='{{ mat.id }}' sel='recuperacion'/>
                                                </td>
                                                <td>
                                                    {{mat.ver_historiconotas.notafinal|floatformat}}
                                                </td>
                                            {% endif %}
                                        {% else %}
                                            {# aqui cuando ya este aprobado presentar notas del record e historico #}
                                            <td>
                                                {{ mat.ver_historiconotas.n1}}
                                            </td>
                                            <td>
                                                {{ mat.ver_historiconotas.n2}}
                                            </td>
                                            <td>
                                                {{ mat.ver_historiconotas.n3}}
                                            </td>
                                            <td>
                                                {{ mat.ver_historiconotas.n4}}
                                            </td>
                                            <td>
                                                {{ mat.ver_historiconotas.n5 }}
                                            </td>
                                            <td>
                                                {{mat.ver_historiconotas.notafinal|floatformat}}
                                            </td>
                                            <td>
                                                {{mat.ver_historiconotas.recup|floatformat}}
                                            </td>
                                        {% endif %}
                                            <td>
                                                {% if mat.ver_recordmateria.asistencia < asistencia_aprobar %} <span style="color: #dc143c;"><b>{{ mat.ver_recordmateria.asistencia|floatformat }}%</b></span>{% endif %}
                                                {% if mat.ver_recordmateria.asistencia >= asistencia_aprobar %} <span style="color:#006400;"><b>{{ mat.ver_recordmateria.asistencia|floatformat }}%</b></span>{% endif %}
                                            </td>
                                            <td>
                                                {% if mat.ver_historiconotas.estado.id == reprobado %} <span style="color: #dc143c;"><b>{{ mat.ver_historiconotas.estado.nombre }} </b></span>{% endif %}
                                                {% if mat.ver_historiconotas.estado.id != reprobado %} <span style="color:#006400;"><b>{{ mat.ver_historiconotas.estado.nombre }} </b></span>{% endif %}
                                            </td>
                                            <td style="background-color: aliceblue; text-align: center;width:15%">
                                                {% if mat.tiene_evaluacionalcance.motivo  %}
                                                    {{ mat.tiene_evaluacionalcance.motivo.motivo }}
                                                {% else %}
                                                    {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                        <a href="#"id='{{ mat.id }}'class='btn btn-info'><i class="icon-plus"></i> Motivo </a>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if  mat.ver_recordmateria.asistencia >= asistencia_aprobar %}
                                                    {% if not mat.ver_recordmateria.aprobada or not mat.ver_historiconotas.estado.id == reprobado or mat.ver_historiconotas.permitir %}
                                                        {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                            <a href="/alcance_nivelcerrado?action=observaciones&id={{ mat.id }}" class='{% if mat.tiene_evaluacionalcance.observaciones %} btn btn-mini btn-warning{% else %}btn btn-mini{% endif %}'><i class="icon-comment"></i> Obs.
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td style="text-align: center;">
                                                {% if not mat.tiene_evaluacionalcance.aprobado or not mat.tiene_evaluacionalcance.aprobadoex or not mat.tiene_evaluacionalcance.aprobadorec and not mat.evaluacion.estado.id == reprobado %}
                                                    {% if not mat.tiene_evaluacionalcance.enviado and not mat.ver_historiconotas.permitir %}
                                                         <input type='checkbox'  title="Utilizar cuando termine ingreso de notas."  class='notascorreo' idmat='{{ mat.id }}'/>
                                                    {% else %}
                                                         <a href="#" title="Enviado" class="estado"><img src='/static/images/16/true.png' alt='Si' border='0'/></a>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td style="text-align: center;">
                                                {# OCastillo 13-09-2022 se agrega condicion de compra y aprobacion de especies para asentamiento de notas en nivel cerrado #}
                                                {% if not mat.ver_recordmateria.aprobada or not mat.ver_historiconotas.estado.id == reprobado and not mat.ver_historiconotas.permitir %}
    {#                                            {% if mat.ver_historiconotas.estado.id == reprobado and not mat.ver_historiconotas.permitir %}#}
                                                    {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                         <input type='checkbox'  title="Utilizar para solicitar permiso a secretaria para cambiar notas."  class='solicpermiso' idmat='{{ mat.id }}'/>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                    {% else %}
                                        {# sino existe observacion y motivo  #}
                                        <td>{% if mat.ver_historiconotas.n1 %} {{mat.ver_historiconotas.n1 }}{% else %} {{ mat.evaluacion.n1 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n2 %} {{mat.ver_historiconotas.n2 }}{% else %} {{ mat.evaluacion.n2 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n3 %} {{mat.ver_historiconotas.n3 }}{% else %} {{ mat.evaluacion.n3 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n4 %} {{mat.ver_historiconotas.n4 }}{% else %} {{ mat.evaluacion.n4 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n5 %} {{mat.ver_historiconotas.n5 }}{% else %} {{ mat.evaluacion.examen }}{% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.recup %} {{mat.ver_historiconotas.recup }}{% else %} {{ mat.evaluacion.recup }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.notafinal %} {{mat.ver_historiconotas.notafinal|floatformat }}{% else %} {{ mat.notafinal|floatformat }} {% endif %}</td>
                                        <td>
                                            {% if mat.ver_recordmateria.asistencia < asistencia_aprobar %} <span style="color: #dc143c;"><b>{{ mat.ver_recordmateria.asistencia }}%</b></span>{% endif %}
                                            {% if  mat.ver_recordmateria.asistencia >= asistencia_aprobar %} <span style="color:#006400;"><b>{{ mat.ver_recordmateria.asistencia }}%</b></span>{% endif %}
                                        </td>
                                        <td>
                                            {% if mat.ver_historiconotas.estado.id == reprobado %}<span style="color: #dc143c;"><b> {{mat.ver_historiconotas.estado.nombre }}</b></span>{% else %}<span style="color: green"><b>{% if mat.ver_historiconotas.estado.nombre %}{{mat.ver_historiconotas.estado.nombre }}{% else %}{{mat.evaluacion.estado.nombre }}{% endif %}</b></span>{% endif %}
                                        </td>
                                        <td>
                                            {% if  mat.ver_recordmateria.asistencia >= asistencia_aprobar %}
                                                {% if not mat.ver_recordmateria.aprobada and not mat.ver_historiconotas.estado.id == reprobado %}
                                                    {% if mat.tiene_evaluacionalcance.motivo  %}
                                                        {{ mat.tiene_evaluacionalcance.motivo.motivo }}
                                                    {% else %}
                                                        {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento and mat.ver_historiconotas.permitir %}
                                                            <a href="#"id='{{ mat.id }}'class='btn btn-info'><i class="icon-plus"></i> Motivo </a>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if  mat.ver_recordmateria.asistencia >= asistencia_aprobar %}
                                                {% if not mat.ver_recordmateria.aprobada and not mat.ver_historiconotas.estado.id == reprobado or mat.ver_historiconotas.permitir %}
                                                    {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                        <a href="/alcance_nivelcerrado?action=observaciones&id={{ mat.id }}" class='{% if mat.tiene_evaluacionalcance.observaciones %} btn btn-mini btn-warning{% else %}btn btn-mini{% endif %}'><i class="icon-comment"></i> Obs. </a>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td style="text-align: center;">
                                            {% if mat.ver_historiconotas.estado.id == reprobado or mat.ver_historiconotas.estado.id == examen or mat.ver_historiconotas.estado.id == recuperacion or mat.ver_historiconotas.estado.id == aprobado and not mat.ver_historiconotas.permitir %}
                                                {% if mat.ver_asentamiento or mat.ver_examen or mat.ver_recuperacion or mat.ver_mejoramiento %}
                                                    <input type='checkbox'  title="Utilizar para solicitar permiso a secretaria para cambiar notas."  class='solicpermiso' idmat='{{ mat.id }}'/>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td> </td>
                                    {% endif %}
                                {% else %}
                                        {# caso reprobados  #}
                                        <td>{% if mat.ver_historiconotas.n1 %} {{mat.ver_historiconotas.n1 }}{% else %} {{ mat.evaluacion.n1 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n2 %} {{mat.ver_historiconotas.n2 }}{% else %} {{ mat.evaluacion.n2 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n3 %} {{mat.ver_historiconotas.n3 }}{% else %} {{ mat.evaluacion.n3 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n4 %} {{mat.ver_historiconotas.n4 }}{% else %} {{ mat.evaluacion.n4 }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.n5 %} {{mat.ver_historiconotas.n5 }}{% else %} {{ mat.evaluacion.examen }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.recup %} {{mat.ver_historiconotas.recup }}{% else %} {{ mat.evaluacion.recuperacion }} {% endif %}</td>
                                        <td>{% if mat.ver_historiconotas.notafinal %} {{mat.ver_historiconotas.notafinal }}{% else %} {{ mat.notafinal }} {% endif %}</td>
                                        <td>{% if mat.asistenciafinal < asistencia_aprobar %} <span style="color: #dc143c;"><b>{{ mat.asistenciafinal|floatformat }}%</b></span>{% endif %}
                                            {% if mat.asistenciafinal >= asistencia_aprobar %} <span style="color:#006400;"><b>{{ mat.asistenciafinal|floatformat }}%</b></span>{% endif %}
                                        </td>
                                        <td>{% if mat.ver_historiconotas.estado.id == reprobado %}<span style="color: #dc143c;"><b> {{mat.ver_historiconotas.estado.nombre }}</b></span>{% endif %}</td>
                                {% endif %}
                            </tr>
                         {% endwith %}
                   {% endif %}
                {% endfor %}
                {% if not materia %}
                    <tr>
                        <td colspan="6" align='center'>NO EXISTEN REGISTROS</td>
                    </tr>
                {% endif %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan='14'>
                            {%  if materia.verifica_alcancenivelcerrado %}
                                <a id="rep" href="/reportes?action=run&direct=true&n=acta_alcance_nivelcerrado&rt=pdf&materia={{ materia.id }}" class="btn btn-success"><i class="icon-print"></i> Acta de Alcance</a>
                            {% endif %}
                        </td>
                    </tr>
                </tfoot>

            </table>
        </div>
    </div>

{% endblock %}

{% block moreblock %}
    <div class="modal fade static" id="motivopanel" style="width: 20px;">
            <div class="modal-header">
                <div id="paneltitle"></div>
            </div>
            <div class="modal-body" style="height: 20px;">
                <div id="panelbody">
                    <div class="row-fluid">
                        <div>
                            Tipo Motivo:
                            <select style="width: 200px;" id='seltrans'>
                                {% for mot in motivonota %}
                                    <option value="{{ mot.id }}">{{ mot.motivo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <br/>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-success btn-ejecutar"> <b> Aceptar</b></a>
                <a href="#" class="btn btn-info btn-cerrar">Salir</a>

            </div>
    </div>

    <div class="modal fade static" id="tipoaprobacionpanel" style="width: 100px;">
            <div class="modal-header">
                <div id="paneltitle"></div>
            </div>
            <div class="modal-body" style="height: 500px;">
                <form id="formulario5"  action="" method="POST">
                {% for field in aprobacionform %}
                    <fieldset class="control-group nomargins">
                    <label style="text-align: left;"  for="id_{{ field.name }}"><b>{{ field.label }}:</b></label>
                        <div class="controls">
                            {{ field }}
                            <p class="help-text">{{ field.help_text }} </p>
                        </div>
                    </fieldset>
                {% endfor %}
                </form>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-guardar btn-success"> <b> Aceptar</b></a>
                <a href="#" class="btn btn-cerrar btn-warning">Salir</a>
            </div>
    </div>

{% endblock %}