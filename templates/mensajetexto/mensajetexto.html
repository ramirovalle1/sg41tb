{% extends "basebs.html" %}
{% load humanize %}
{% block heading %}

    <style>
         .nav-side-menu1 {
          overflow: hidden;
          font-family: verdana;
          font-size: 12px;
          font-weight: 200;
{#          background-color: #2e353d;#}
          position: inherit;
          margin-top: 10px;
          width: 100%;
{#          margin-left: -20px;#}
          height: 100%;
          color: rgba(106, 106, 106, 0.63);
        }
        .nav-side-menu1 .brand {
            background-color: #41a7c4;
            background: -moz-linear-gradient(top, #429eb8 0%, #7bcbe3 44%, #389fbc 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#429eb8), color-stop(44%,#7bcbe3), color-stop(100%,#389fbc)); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* Opera 11.10+ */
            background: -ms-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* IE10+ */
            background: linear-gradient(to bottom,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* W3C */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7bcbe3', endColorstr='#389fbc',GradientType=0 ); /* IE6-9 */
            border-radius: 10px 10px 0 0;
            line-height: 50px;
            display: block;
            text-align: center;
            font-size: 14px;
        }
        .nav-side-menu1 .brand1 {
            background-color: #41a7c4;
            background: -moz-linear-gradient(top, #429eb8 0%, #7bcbe3 44%, #389fbc 100%); /* FF3.6+ */
            background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#429eb8), color-stop(44%,#7bcbe3), color-stop(100%,#389fbc)); /* Chrome,Safari4+ */
            background: -webkit-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* Chrome10+,Safari5.1+ */
            background: -o-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* Opera 11.10+ */
            background: -ms-linear-gradient(top,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* IE10+ */
            background: linear-gradient(to bottom,  #429eb8 0%,#7bcbe3 44%,#389fbc 100%); /* W3C */
            filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7bcbe3', endColorstr='#389fbc',GradientType=0 ); /* IE6-9 */
            border-radius: 10px 10px 10px 10px;
            line-height: 50px;
            display: block;
            text-align: center;
            font-size: 14px;
        }
        .container-fluid> .nav-side-menu1 .toggle-btn {
          display: none;
        }
        .nav-side-menu1 ul,
        .nav-side-menu1 li {
          list-style: none;
          padding: 0px;
          margin: 0px;
          line-height: 35px;
          cursor: pointer;
          /*
            .collapsed{
               .arrow:before{
                         font-family: FontAwesome;
                         content: "\f053";
                         display: inline-block;
                         padding-left:10px;
                         padding-right: 10px;
                         vertical-align: middle;
                         float:right;
                    }
             }
        */
        }
        .nav-side-menu1 ul :not(collapsed) .arrow:before,
        .nav-side-menu1 li :not(collapsed) .arrow:before {
          font-family: FontAwesome;
          content: "\f078";
          display: inline-block;
          padding-left: 10px;
          padding-right: 10px;
          vertical-align: middle;
          float: right;
        }
        .nav-side-menu1 ul .active,
        .nav-side-menu1 li .active {
        border-left: 1px solid rgba(41, 152, 189, 0.60);
        border-right: 1px solid rgba(41, 152, 189, 0.60);
        background-color: #dddddd;


        }
        .nav-side-menu1 ul .sub-menu li.active,
        .nav-side-menu1 li .sub-menu li.active {
          color: rgba(52, 52, 52, 0.31);
        }
        .nav-side-menu1 ul .sub-menu li.active a,
        .nav-side-menu1 li .sub-menu li.active a {
{#          color: rgba(52, 52, 52, 0.47);#}
        }
         .nav-side-menu1 ul .sub-menu li,
        .nav-side-menu1 li .sub-menu li {
          background-color: rgb(255, 255, 255);





          border: none;
          line-height: 28px;
          border-bottom: 1px solid rgba(35, 40, 46, 0.18);
          margin-left: 0px;
        }
        .nav-side-menu1 ul .sub-menu li:before,
        .nav-side-menu1 li .sub-menu li:before {
          font-family: FontAwesome;
{#          content: "\f105";#}
          display: inline-block;
          padding-left: 10px;
          padding-right: 10px;
          vertical-align: middle;
        }
        .nav-side-menu1 li {
          padding-left: 0px;
          border-left: 3px solid rgba(46, 53, 61, 0.58);
          border-bottom: 1px solid rgba(35, 40, 46, 0.50);
        }
        .nav-side-menu1 li a {
          text-decoration: none;
          color: rgba(52, 52, 52, 0.56);
        }
         .nav-side-menu1 li a i {
          padding-left: 10px;
          width: 20px;
          padding-right: 20px;
        }
        .nav-side-menu1 li:hover {
          border-left: 3px solid rgba(25, 0, 26, 0.41);
{#          background-color: rgba(79, 91, 105, 0.51);#}
          -webkit-transition: all 1s ease;
          -moz-transition: all 1s ease;
          -o-transition: all 1s ease;
          -ms-transition: all 1s ease;
          transition: all 1s ease;
        }
        @media (max-width: 767px) {
          .nav-side-menu1 {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
          }
          .nav-side-menu1 .toggle-btn {
            display: block;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 10px;
            z-index: 10 !important;
            padding: 3px;
            background-color: #ffffff;
            color: #000;
            width: 40px;
            text-align: center;
          }
          .brand {
            text-align: left !important;
            font-size: 22px;
            padding-left: 20px;
            line-height: 50px !important;
          }

        }
        @media (min-width: 767px) {
          .nav-side-menu1 .menu-list1 .menu-content {
            display: block;
          }
        }

        body {
          margin: 0px;
          padding: 0px;
        }
        .ocultar{
            display: none;
        }
        .aparecer{
            display: block;
        }
        #tarea:hover{
          background-color: rgba(2, 2, 26, 0.35);
        }

        #subtarea:hover{
          background-color: rgb(142, 142, 149);
        }


        #actividad:hover{
          background: rgba(186, 186, 186, 0.80);
        }
        #actividad{
          background: rgba(246, 246, 246, 0.61);
        }

    </style>
    <script type="text/javascript">
        $(function(){
            $($("#mensaje").get(0).parentNode).find(".help-text").html("");
            $("#mensaje").keydown(function(){
               $($("#mensaje").get(0).parentNode).find(".help-text").html("");
               if($("#mensaje").val().length == 160){
                   $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b> No se permite exceder los 160 caracteres</b>");
               }
            });
            var accionfiltro = "";
            $('#filtromensaje').change(function(){
                $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("");
                $("#listapersona").hide();  
                $("#tbodyform").html('');  
                $(".help-text2").html('');
                $(".help-text1").html('');
                $('#mensaje').attr('readonly',true);
                $('#grupo').attr('myval',0);
                $('#grupo').val('');
                $('#nivel').attr('myval',0);
                $('#nivel').val('');
                $('#periodo').attr('myval',0);
                $('#periodo').val('');
                $('#carrera').attr('myval',0);
                $('#carrera').val('');

                if($('#filtromensaje').val() =='BECADOS'){
                    $('#periodo').show();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#carrera').hide();
                    $('#celulares').hide();
                }
                else if($('#filtromensaje').val() =='GRUPO'){
                    $('#grupo').show();
                    $('#nivel').hide();
                    $('#carrera').hide();
                    $('#periodo').hide();
                }

                else if($('#filtromensaje').val() =='NIVEL'){
                    $('#nivel').show();
                    $('#carrera').hide();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='PERIODO'){
                    $('#periodo').show();
                    $('#carrera').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='GRADUADOS'){
                    $('#carrera').show();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                     $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='EGRESADOS'){
                    $('#carrera').show();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                     $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='RETIRADOS'){
                    $('#carrera').show();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='ABSENTISMO'){
                    $('#carrera').show();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='CARRERA'){
                    $('#carrera').show();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#celulares').hide();
                }

                else if($('#filtromensaje').val() =='MANUAL'){
                    $('#celulares').show();
                    $('#carrera').hide();
                    $('#periodo').hide();
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#mensaje').attr('readonly',false);
                }
                else{
                    $('#grupo').hide();
                    $('#nivel').hide();
                    $('#periodo').hide();
                    $('#carrera').hide();
                    $('#mensaje').attr('readonly',false);
                }

            });

            buscar_nivel = function(query, process) {
                $(".help-text2").html('');
                $(".help-text1").html('');
                $.get("/reportes", {'action':'databiblio', 'model': 'Nivel:cerrado=False',
                    'p': 1, 'q': query, 's': 10}, function(data) {
                    if (data.results.length <=0) {
                        $("#nivel").get(0).results = [];
                        listing = [];
                        $('#mensaje').attr('readonly',true);
                        $("#nivel").attr("myval",0);
                        $("#nivel").val("");
                        process(listing);
                    }else {
                        $("#nivel").get(0).results = data.results;
                        listing = [];
                        for (var i in data.results) {
                            var dato = data.results[i];
                            listing.push(dato.alias);
                        }
                        process(listing);
                    }
                }, 'json');
            };
            $('#nivel').typeahead({source: buscar_nivel, updater: function(item) {
                var results = $("#nivel").get(0).results;
                for (var i in results) {
                    var datos = results[i];
                    if (item==datos.alias) {
                        $("#nivel").attr("myval",datos.id);
                        $('#mensaje').attr('readonly',false);
                    }
                }
                return item;
            }});

            buscar_grupo = function(query, process) {
                $(".help-text2").html('');
                $(".help-text1").html('');
                $.get("/reportes", {'action':'data', 'model': 'Grupo',
                    'p': 1, 'q': query, 's': 10}, function(data) {
                    if (data.results.length <=0) {
                        $("#grupo").get(0).results = [];
                        listing = [];
                        $('#mensaje').attr('readonly',true);
                        $("#grupo").attr("myval",0);
                        $("#grupo").val("");
                        process(listing);
                    }else {
                        $("#grupo").get(0).results = data.results;
                        listing = [];
                        for (var i in data.results) {
                            var dato = data.results[i];
                            listing.push(dato.name);
                        }
                        process(listing);
                    }
                }, 'json');
            };
            $('#grupo').typeahead({source: buscar_grupo, updater: function(item) {
                var results = $("#grupo").get(0).results;
                for (var i in results) {
                    var datos = results[i];
                    if (item==datos.name) {
                        $("#grupo").attr("myval",datos.id);
                        $('#mensaje').attr('readonly',false);
                    }
                }
                return item;
            }});

            buscar_periodo = function(query, process) {
                $(".help-text2").html('');
                $(".help-text1").html('');
                $.get("/reportes", {'action':'databiblio', 'model': 'Periodo:activo=True',
                    'p': 1, 'q': query, 's': 10}, function(data) {
                    if (data.results.length <=0) {
                        $("#periodo").get(0).results = [];
                        listing = [];
                        $('#mensaje').attr('readonly',true);
                        $("#periodo").attr("myval",0);
                        $("#periodo").val("");
                        process(listing);
                    }else {
                        $("#periodo").get(0).results = data.results;
                        listing = [];
                        for (var i in data.results) {
                            var dato = data.results[i];
                            listing.push(dato.name);
                        }
                        process(listing);
                    }
                }, 'json');
            };
            $('#periodo').typeahead({source: buscar_periodo, updater: function(item) {
                var results = $("#periodo").get(0).results;
                for (var i in results) {
                    var datos = results[i];
                    if (item==datos.name) {
                        $("#periodo").attr("myval",datos.id);
                        $('#mensaje').attr('readonly',false);
                    }
                }
                return item;
            }});

            buscar_carrera = function(query, process) {
                $(".help-text2").html('');
                $(".help-text1").html('');
                $.get("/reportes", {'action':'data', 'model': 'Carrera',
                    'p': 1, 'q': query, 's': 10}, function(data) {
                    if (data.results.length <=0) {
                        $("#carrera").get(0).results = [];
                        listing = [];
                        $('#mensaje').attr('readonly',true);
                        $("#carrera").attr("myval",0);
                        $("#carrera").val("");
                        process(listing);
                    }else {
                        $("#carrera").get(0).results = data.results;
                        listing = [];
                        for (var i in data.results) {
                            var dato = data.results[i];
                            listing.push(dato.name);
                        }
                        process(listing);
                    }
                }, 'json');
            };
            $('#carrera').typeahead({source: buscar_carrera, updater: function(item) {
                var results = $("#carrera").get(0).results;
                for (var i in results) {
                    var datos = results[i];
                    if (item==datos.name) {
                        $("#carrera").attr("myval",datos.id);
                        $('#mensaje').attr('readonly',false);
                    }
                }
                return item;
            }});

            listaperso = [];
            $("#enviar").click(function(){
                $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("");
                $("#listapersona").hide();
                $("#tbodyform").html('');
                showWaiting("Enviando Mensajes","<i class='fa fa-spinner fa-spin'></i> Espere unos segundos por favor...");
                var valida = true;
                var id=0;
                if($('#filtromensaje').val() =='BECADOS'){
                    if($("#periodo").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Periodo');
                        valida = false;
                    }else{
                        id = $("#periodo").attr("myval")
                    }
                }
                else if($('#filtromensaje').val() =='GRUPO'){
                    if($("#grupo").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Grupo');
                        valida = false;
                    }else{
                        id = $("#grupo").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='NIVEL'){
                    if($("#nivel").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Nivel');
                        valida = false;
                    }else{
                        id = $("#nivel").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='PERIODO'){
                    if($("#periodo").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Periodo');
                        valida = false;
                    }else{
                        id = $("#periodo").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='GRADUADOS'){
                    if($("#carrera").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Carrera');
                        valida = false;
                    }else{
                        id = $("#carrera").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='EGRESADOS'){
                    if($("#carrera").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Carrera');
                        valida = false;
                    }else{
                        id = $("#carrera").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='RETIRADOS'){
                    if($("#carrera").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Carrera');
                        valida = false;
                    }else{
                        id = $("#carrera").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='ABSENTISMO'){
                    if($("#carrera").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Carrera');
                        valida = false;
                    }else{
                        id = $("#carrera").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='CARRERA'){
                    if($("#carrera").attr("myval") <= 0){
                        $(".help-text2").html('Ingrese Carrera');
                        valida = false;
                    }else{
                        id = $("#carrera").attr("myval")
                    }
                }

                else if($('#filtromensaje').val() =='MANUAL'){
                    if($("#celulares").val() == ''){
                        $(".help-text2").html('Ingrese Celulares');
                        valida = false;
                    }else{
                        id = $("#celulares").val();
                    }
                }
                else{
                    if($('#filtromensaje').val()==''){
                        $(".help-text1").html('Seleccione una Opcion');
                        valida = false;
                    }
                }
                if($('#mensaje').val() == ''){
                    $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b> Ingrese el mensaje</b>");
                    valida = false;
                }
                if(valida){
                    accionfiltro = $('#filtromensaje').val();
                    $.post("/mensajetexto", {action: $('#filtromensaje').val(), 'id': id, 'mensaje':$("#mensaje").val()}, function(data) {
                        hideWaiting();
                        if (data.result=='ok') {
                            if(parseInt(data.contador) != parseInt(data.registros)){
                                $("#listapersona").show();
                                var htmlString = '';
                                for(var i in data.listapersona){
                                    var dato = data.listapersona[i];
                                    listaperso.push({"nombre": dato.nombre, "celular": dato.celular});
                                    htmlString = htmlString + "<tr><td>"+ dato.nombre+"</td><td>"+ dato.celular +"</td></tr>";
                                }
                                $("#tbodyform").html(htmlString);                                
                            }
                            $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b> Mensajes enviados "+ data.contador+" de "+ data.registros+"</b>");
                            return false;
                        }                        
                        else{
                            if (data.result == 'noinfo'){
                                $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b>No existe informacio para enviar el mensaje </b>");
                            }
                            else if (data.result == 'badmensj'){
                                $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b>Error en el mensaje </b>");
                            }
                            else{
                                $($("#mensaje").get(0).parentNode).find(".help-text").attr({'style':'color:black;margin-left:4%'}).html("<b> Error al enviar el mensaje, Mensajes enviados "+ data.contador+" de "+ data.registros+"</b>");
                            }
                        }
                    }, "json");
                }
                else{
                    hideWaiting();
                }
            });

            $("#excel").click(function(){
                showWaiting("Creando Excel","<i class='fa fa-spinner fa-spin'></i> Espere unos segundos por favor...");
                $.post("/mensajetexto", {"action":'crearexcel', "datos": JSON.stringify(listaperso),"accionfiltro":accionfiltro}, function(data) {
                    if (data.result=='ok') {
                        window.open(data.url, 'width='+(screen.availWidth)+',height ='+(screen.availHeight)+',fullscreen=yes,menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=no');
                        hideWaiting();
                    }
                });
            });
        });
    </script>
{% endblock %}
{% block canvas %}
    <div class="row-fluid ">
        <div class="span3"></div>
        <div class="span4"></div>
        <div class="span1">
           <div class='atright'>
                <a href="/" class='btn'><i class="icon-arrow-left"></i> Atras</a>
           </div>
        </div>
    </div>
    <div class="row-fluid ">
        <div class="span3"></div>
        <div class="span4">
            <form class="form-search">

                <a href="#" id='search' class='btn btn-info'>Enviar Mensaje a</a>

                <select id='filtromensaje' class="searchinput input-large search-query"/>
                    <option value=''>-----</option>
                    {% for f in FILTROS_MENSAJE %}
                        {% if persona.usuario.is_superuser and f == "MANUAL"%}
                            <option value="{{ f }}" >{{ f }}</option>
                        {% else %}
                            {% if  f != "MANUAL"%}
                                <option value="{{ f }}" >{{ f }}</option>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </select>
                <p class="help-text1"></p>
            </form>
        </div>
    </div>

    <div class="row-fluid ">
        <div class="span4"></div>
        <div class="span4" >

            <input class='searchinput input-small search-query' type='text' id='grupo' myval='0' autocomplete="off" placeholder="Ingrese Grupo" style="display: none"/>
            <input class='searchinput input-xlarge search-query' type='text' id='periodo' myval='0' autocomplete="off" placeholder="Ingrese Periodo" style="display: none"/>
            <input class='searchinput input-xlarge search-query' type='text' id='nivel' myval='0' autocomplete="off" placeholder="Ingrese Nivel" style="display: none"/>
            <input class='searchinput input-xxlarge search-query' type='text' id='carrera' myval='0' autocomplete="off" placeholder="Ingrese Carrera" style="display: none"/>
            {% if persona.usuario.is_superuser %}
                <input class='searchinput input-xxlarge search-query' type='text' id='celulares' myval='0' autocomplete="off" placeholder="Ingrese numero de celulares" style="display: none"/>
            {% endif %}
            <p class="help-text2"></p>

        </div>
    </div>

    <div class="row-fluid ">
        <div class="span4"></div>
        <div class="span4">
            <div class="nav-side-menu1">
                <div class="brand" style="color: #000000"><a  style="cursor: pointer"><strong>Enviar Mensaje</strong></a></div>
                <div class="menu-list">
                    <ul id="menu-content" class="menu-content" style="text-align: center">

                        <li class="collapsed active tarea" id="tarea">
                              <textarea placeholder="Escribir mensaje" id='mensaje' maxlength="160" rows="4" cols="50" style="width: 90%;margin-top: 4%" readonly></textarea>
                              <p class="help-text"></p>
                            <a class="btn" id="enviar" style="border-radius: 50px;cursor: pointer">enviar</a>
                        </li>



                    </ul>
                </div>
            </div>
        </div>

        <div class="span6" id="area"  style="margin-top: 10px" >
        </div>
        <div class="span1" style="width: 5%"></div>
    </div>
    <div class="row-fluid " id="listapersona" style="display: none">
        <div class="span4"></div>
        <div class="span4">

            <table class='table table-striped table-bordered' cellpadding="0" cellspacing="0">
                <thead>
                    <tr>
                        <th colspan="2" style="text-align: center">
                            <h4>No enviados<span style="float: right;cursor: pointer" id='excel' >
                                <i><img src="/static/images/excel.png"/></i>
                            </span></h4>
                        </th>
                    </tr>
                </thead>
                <thead>
                    <tr>
                        <th class="pagination-centered">Nombre</th>
                        <th class="pagination-centered">Celular</th>
                    </tr>
                </thead>
                <tbody id="tbodyform">
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}